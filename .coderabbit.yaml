# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

language: ko-KR
tone_instructions: |
  한국 주니어 백엔드 개발자의 포트폴리오 프로젝트를 리뷰하는 시니어 개발자 관점으로 작성.
  실무 투입 가능한 코드 품질을 기준으로 구체적인 개선점을 제시.
  우아한테크캠프/네이버 캠퍼스 핵데이 수준의 코딩 컨벤션을 기준으로 평가.
early_access: false
enable_free_tier: true

reviews:
  profile: assertive
  request_changes_workflow: true
  high_level_summary: true
  high_level_summary_placeholder: "@coderabbitai summary"
  review_status: true
  commit_status: true
  collapse_walkthrough: false
  changed_files_summary: true
  sequence_diagrams: true
  poem: false

  path_filters:
    - "!**/*.md"
    - "!docs/**"
    - "!.claude/**"
    - "!.github/**"
    - "!docker-compose*.yml"
    - "!k6-results/**"

  path_instructions:
    - path: "src/main/java/**/*.java"
      instructions: |
        Java 코딩 표준을 엄격히 검사:
        1. `else` 키워드 사용 금지 — Early Return, Guard Clause, 다형성으로 대체 (테스트 코드 제외)
        2. 메서드 들여쓰기 깊이 2 이하
        3. 메서드 길이 15줄 이하
        4. 메서드 파라미터 3개 이하 (초과 시 Request/Command 객체로 래핑)
        5. 매직 넘버/문자열 금지 — 상수 또는 설정으로 추출
        6. System.out.println 금지 — @Slf4j 로거 사용
        7. 주석 처리된 코드 금지 — Git이 이력 관리
        8. DTO는 record 사용 권장

    - path: "src/main/java/**/controller/**/*.java"
      instructions: |
        Controller 레이어 규칙:
        1. 컨트롤러는 얇아야 한다 — 모든 비즈니스 로직은 서비스에 위임
        2. @Valid 필수 — RequestBody에 반드시 사용
        3. @AuthenticationPrincipal로 사용자 컨텍스트 접근
        4. 반환 타입: ResponseEntity<ApiResponse<T>> (204 No Content 예외: ResponseEntity.noContent().build())
        5. 예외를 직접 catch하지 않음 — GlobalExceptionHandler에 위임
        6. REST 규칙: 복수 명사, 하이픈, 소문자 URI (/api/v1/time-deals/{id})
        7. HTTP 메서드: GET=조회, POST=생성(또는 도메인 커맨드), PATCH=부분수정, DELETE=삭제
        8. 상태코드: 201(생성), 204(삭제), 400(검증), 409(비즈니스 충돌)

    - path: "src/main/java/**/service/**/*.java"
      instructions: |
        Service 레이어 규칙:
        1. @Transactional 필수 — 읽기 전용은 @Transactional(readOnly = true)
        2. 같은 클래스 내 @Transactional 메서드 중첩 호출 금지 (프록시 제한)
        3. 비즈니스 예외는 CustomException(ErrorCode) 사용 — 원시 예외 금지
        4. 도메인 간 호출은 Service 레이어에서만 허용
        5. 상태 변경 후 도메인 이벤트 발행

    - path: "src/main/java/**/repository/**/*.java"
      instructions: |
        Repository 레이어 규칙:
        1. JpaRepository<Entity, Long> 확장
        2. 커스텀 쿼리는 @Query JPQL 사용 (Native SQL은 불가피한 경우만)
        3. Lock 쿼리는 별도 메서드: findByIdForUpdate()
        4. @Modifying(clearAutomatically = true) 필수 — UPDATE/DELETE 쿼리
        5. N+1 쿼리 패턴 확인: fetch join 또는 @EntityGraph 사용
        6. 목록 조회는 커서 기반 페이지네이션 (offset 금지)

    - path: "src/main/java/**/entity/**/*.java"
      instructions: |
        Entity 규칙:
        1. BaseEntity 상속 (createdAt, updatedAt 자동 관리)
        2. @Getter만 사용, @Setter 금지 — 상태 변경은 도메인 메서드로
        3. 비즈니스 로직은 엔티티 내부에 (Tell, Don't Ask)
        4. 연관관계 지연 로딩(LAZY) 기본
        5. 생성자는 정적 팩토리 메서드 또는 @Builder 사용

    - path: "src/main/java/**/config/**/*.java"
      instructions: |
        설정 클래스 규칙:
        1. @Configuration + @Bean 메서드 방식
        2. 필드 주입(@Autowired) 금지 — 생성자 주입(@RequiredArgsConstructor)
        3. 환경별 분리: @Profile("local"), @Profile("test")
        4. 전략 선택: @ConditionalOnProperty

    - path: "src/test/java/**/*.java"
      instructions: |
        테스트 코드 규칙:
        1. 메서드명 한국어 허용: createOrder_재고부족_예외발생()
        2. Given-When-Then 구조, 빈 줄로 구분
        3. 단위 테스트: @ExtendWith(MockitoExtension.class) — @SpringBootTest 금지
        4. 통합 테스트: Testcontainers @ServiceConnection
        5. 동시성 테스트: ExecutorService + CountDownLatch
        6. 모든 public 서비스 메서드에 최소 1개 테스트
        7. else 키워드는 테스트 헬퍼에서 허용

    - path: "src/main/java/**/global/error/**/*.java"
      instructions: |
        에러 처리 규칙:
        1. 모든 비즈니스 예외는 CustomException + ErrorCode enum
        2. @RestControllerAdvice 글로벌 핸들러
        3. Validation 에러: fieldErrors 배열 형태
        4. 로깅: ERROR(장애), WARN(비즈니스 예외), INFO(요청/응답)
        5. 민감값(password, token 등) 응답 노출 금지

    - path: "src/main/java/**/order/**/*.java"
      instructions: |
        주문 도메인 (프로젝트 핵심):
        1. 동시성 제어: StockService 인터페이스 + 4단계 구현체 (synchronized → Pessimistic → Optimistic → Redis Lua)
        2. 재고 차감은 주문 저장보다 먼저 (fail-fast)
        3. 1인 1타임딜 유니크 제약 (user_id + time_deal_id)
        4. 취소 시 재고 복원 (이전 상태 무관)
        5. totalPrice는 주문 시점 스냅샷 (참조 아님)

    - path: "src/main/resources/**/*.yml"
      instructions: |
        설정 파일 규칙:
        1. spring.jpa.open-in-view: false 필수
        2. HikariCP: leak-detection-threshold: 30000
        3. hibernate.default_batch_fetch_size: 100
        4. 비밀번호/시크릿 하드코딩 금지 — 환경변수 또는 프로파일

  auto_review:
    enabled: true
    auto_incremental_review: true
    ignore_title_keywords:
      - "WIP"
      - "DO NOT MERGE"
    drafts: false
    base_branches:
      - develop
      - main

  finishing_touches:
    docstrings:
      enabled: false
    unit_tests:
      enabled: false

  tools:
    shellcheck:
      enabled: true
    markdownlint:
      enabled: false
    github-checks:
      enabled: true
      timeout_ms: 120000
    languagetool:
      enabled: false
    hadolint:
      enabled: true
    gitleaks:
      enabled: true
    detekt:
      enabled: false
    eslint:
      enabled: false
    ruff:
      enabled: false
    biome:
      enabled: false
    pmd:
      enabled: false
    yamllint:
      enabled: true

chat:
  auto_reply: true

knowledge_base:
  opt_out: false
  learnings:
    scope: auto
  issues:
    scope: auto
  pull_requests:
    scope: auto
  code_guidelines:
    enabled: true
    filePatterns:
      - ".claude/rules/coding-standards.md"
      - ".claude/rules/review-standards.md"
      - ".claude/rules/domain-rules.md"
      - ".claude/rules/spring-conventions.md"
      - ".claude/rules/architecture.md"
